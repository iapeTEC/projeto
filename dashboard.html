<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Dashboard de Presença</title>
  <style>
    body{font-family:Arial,sans-serif;margin:0;background:#f4f6f8;color:#222}
    .wrap{max-width:1200px;margin:0 auto;padding:16px}
    .card{background:#fff;border-radius:10px;padding:14px;box-shadow:0 1px 6px rgba(0,0,0,.08);margin-bottom:14px}
    .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:12px}
    .metric{border-left:4px solid #4e73df}
    .metric h4{margin:0;font-size:12px;color:#666;text-transform:uppercase}
    .metric .v{font-size:26px;font-weight:700;margin-top:6px}
    table{width:100%;border-collapse:collapse}
    th,td{border:1px solid #e5e7eb;padding:8px;font-size:14px;text-align:left}
    th{background:#f8fafc}
    .filters{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:10px;align-items:end}
    input,select,button{padding:10px;border:1px solid #cbd5e1;border-radius:8px}
    button{background:#2563eb;color:#fff;border:none;font-weight:bold;cursor:pointer}
  
/* ===== SB Admin 2 inspired polish ===== */
:root{
  --sb-primary:#4e73df; --sb-success:#1cc88a; --sb-info:#36b9cc;
  --sb-warning:#f6c23e; --sb-danger:#e74a3b; --sb-dark:#5a5c69;
  --sb-muted:#858796; --sb-border:#e3e6f0; --sb-bg:#f8f9fc;
  --sb-shadow:0 .15rem 1.75rem 0 rgba(58,59,69,.15);
}
body{background:var(--sb-bg)!important;color:#2e2f37!important;font-family:'Nunito',system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif!important}
.wrap{max-width:1220px!important;padding:16px 14px!important}
.card{border:1px solid var(--sb-border)!important;border-radius:.5rem!important;box-shadow:var(--sb-shadow)!important;background:#fff!important}
h2{color:#5a5c69;font-weight:800;letter-spacing:.01em}
label{color:#5a5c69;font-weight:700;font-size:.9rem}
input,select{border:1px solid #d1d3e2!important;border-radius:.35rem!important;padding:.48rem .65rem!important;background:#fff}
input:focus,select:focus{outline:none;border-color:#bac8f3!important;box-shadow:0 0 0 .2rem rgba(78,115,223,.18)}
button{border-radius:.35rem!important;border:1px solid transparent!important;padding:.5rem .85rem!important;font-weight:700!important;background:var(--sb-primary)!important;color:#fff!important;cursor:pointer;box-shadow:0 .125rem .25rem rgba(58,59,69,.2)}
button:hover{filter:brightness(.98)}
.metric{border-left:.35rem solid var(--sb-primary)!important}
.metric:nth-child(2){border-left-color:var(--sb-success)!important}
.metric:nth-child(3){border-left-color:var(--sb-danger)!important}
.metric:nth-child(4){border-left-color:var(--sb-info)!important}
.metric h4{font-size:.72rem!important;font-weight:800!important;letter-spacing:.06em;color:#6e707e!important}
.metric .v{font-size:1.45rem!important;color:#5a5c69!important;font-weight:800!important}
th,td{border-color:var(--sb-border)!important}
thead th{background:#f8f9fc;color:#6e707e;font-size:.78rem;text-transform:uppercase;letter-spacing:.04em;font-weight:800}
tbody tr:nth-child(even){background:#fbfcff}
tbody tr:hover{background:#f3f6ff}
small,.small{color:#858796}

/* Print report area */
.report-print{font-family:Arial,sans-serif;color:#111}
.report-title{font-size:20px;font-weight:700;margin:0 0 4px}
.report-sub{font-size:12px;color:#555;margin:0 0 14px}
.report-section{margin:0 0 18px;page-break-inside:avoid}
.report-section h4{margin:0 0 8px;padding:6px 8px;background:#e5e7eb;border-radius:6px}
.report-table{width:100%;border-collapse:collapse;font-size:13px}
.report-table th,.report-table td{border:1px solid #cbd5e1;padding:6px 8px;vertical-align:top}
.report-table th{background:#f1f5f9}
.report-table tbody tr:nth-child(even){background:#f8fafc}
.report-empty{padding:10px;border:1px dashed #cbd5e1;border-radius:6px;color:#555;background:#fafafa}

@media print {
  body * { visibility:hidden !important; }
  #printArea, #printArea * { visibility:visible !important; }
  #printArea { display:block !important; position:absolute; inset:0; background:#fff; padding:12mm; }
  .report-section { page-break-inside: avoid; }
}

</style>
  <link rel="icon" href="data:,">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
</head>
<body>
  <div style="background:#fff;border-bottom:1px solid #e3e6f0;box-shadow:0 .15rem .35rem rgba(58,59,69,.08);">
    <div style="max-width:1220px;margin:0 auto;padding:12px 14px;display:flex;justify-content:space-between;align-items:center;gap:10px;">
      <div style="font-weight:800;color:#4e73df;display:flex;align-items:center;gap:8px;">
        <span style="width:10px;height:10px;border-radius:50%;background:#4e73df;display:inline-block;"></span>
        Dashboard de Frequência
      </div>
      <div style="font-size:.85rem;color:#858796;">Projetos • Tarde</div>
    </div>
  </div>
<div class="wrap">
  <div class="card">
    <h2 style="margin-top:0">Dashboard de Presença (Projetos da Tarde)</h2>
    <div class="filters">
      <div><label>Data inicial</label><input type="date" id="startDate"></div>
      <div><label>Data final</label><input type="date" id="endDate"></div>
      <div><label>Projeto</label><select id="projectFilter"><option value="">Todos</option></select></div>
      <div><button id="btnAtualizar"><i class="fa-solid fa-rotate-right"></i> Atualizar</button>
      <button id="btnImprimirFaltas" type="button" style="background:#36b9cc;"><i class="fa-solid fa-print"></i> Imprimir faltas do período</button></div>
    </div>
  </div>

  <div class="grid">
    <div class="card metric"><h4>Lançamentos</h4><div class="v" id="mTotal">0</div></div>
    <div class="card metric"><h4>Presentes</h4><div class="v" id="mPres">0</div></div>
    <div class="card metric"><h4>Faltas</h4><div class="v" id="mFalt">0</div></div>
    <div class="card metric"><h4>Frequência geral</h4><div class="v" id="mPct">0%</div></div>
  </div>

  <div class="card">
    <h3 style="margin-top:0">Resumo por projeto</h3>
    <table id="tblResumo">
      <thead><tr><th>Projeto</th><th>Total</th><th>Presentes</th><th>Faltas</th><th>Observações</th><th>Freq. %</th></tr></thead>
      <tbody></tbody>
    </table>
  </div>

  <div class="card">
    <h3 style="margin-top:0">Observações recentes</h3>
    <table id="tblObs">
      <thead><tr><th>Data</th><th>Projeto</th><th>Aluno</th><th>Presença</th><th>Origem</th><th>Observação</th></tr></thead>
      <tbody></tbody>
    </table>
  </div>
</div>

<script src="assets/config2.js"></script>
<script>
const WEB_APP_URL = (window.APP_CONFIG && window.APP_CONFIG.API_URL) || '';

function todayIso(){
  const d = new Date();
  return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
}
if (!WEB_APP_URL) throw new Error('URL do Apps Script não configurada em assets/config2.js');

async function getJson(url){
  const r = await fetch(url);
  const txt = await r.text();
  let j;
  try { j = JSON.parse(txt); }
  catch(e){ throw new Error('Resposta inválida do servidor (não-JSON).'); }
  if (!r.ok) throw new Error(`HTTP ${r.status}`);
  return j;
}


function escapeHtml(s){
  return String(s ?? '')
    .replace(/&/g, '&amp;')
    .replace(/</g, '&lt;')
    .replace(/>/g, '&gt;')
    .replace(/"/g, '&quot;');
}

function groupAbsencesByProject(rows){
  const map = {};
  rows.forEach(r => {
    if (Number(r.present) === 1) return;
    const projeto = String(r.group || r.projeto || 'Sem projeto').trim() || 'Sem projeto';
    if (!map[projeto]) map[projeto] = [];
    map[projeto].push(r);
  });

  return Object.keys(map)
    .sort((a,b)=>a.localeCompare(b,'pt-BR'))
    .map(projeto => ({
      projeto,
      itens: map[projeto].sort((a,b)=>String(a.student||'').localeCompare(String(b.student||''),'pt-BR'))
    }));
}

function buildPrintReportFromDashboardData(j){
  const start = document.getElementById('startDate').value || todayIso();
  const end = document.getElementById('endDate').value || todayIso();

  const rows = Array.isArray(j.rows) ? j.rows : [];
  const groups = groupAbsencesByProject(rows);

  const totalFaltas = rows.filter(r => Number(r.present) !== 1).length;
  const totalSetoresComFalta = groups.length;

  let out = `
    <div class="report-print">
      <p class="report-title">Relatório de Faltas</p>
      <p class="report-sub">
        Período: ${escapeHtml(start)} a ${escapeHtml(end)}<br>
        Total de faltas: ${totalFaltas} | Setores com faltas: ${totalSetoresComFalta}
      </p>
  `;

  if (!groups.length){
    out += `<div class="report-empty">Nenhuma falta registrada no período selecionado.</div>`;
  } else {
    groups.forEach(g => {
      out += `
        <section class="report-section">
          <h4>${escapeHtml(g.projeto)} (${g.itens.length} falta${g.itens.length > 1 ? 's' : ''})</h4>
          <table class="report-table">
            <thead>
              <tr>
                <th style="width:110px">Data</th>
                <th style="width:34%">Aluno</th>
                <th style="width:140px">Responsável</th>
                <th style="width:90px">Origem</th>
                <th>Observação</th>
              </tr>
            </thead>
            <tbody>
      `;
      g.itens.forEach(r => {
        out += `
          <tr>
            <td>${escapeHtml(r.date || '')}</td>
            <td>${escapeHtml(r.student || '')}</td>
            <td>${escapeHtml(r.responsible || '')}</td>
            <td>${escapeHtml(r.source || '')}</td>
            <td>${escapeHtml(r.observation || '')}</td>
          </tr>
        `;
      });
      out += `</tbody></table></section>`;
    });
  }

  out += `</div>`;
  return out;
}

async function imprimirRelatorioFaltas(){
  const start = document.getElementById('startDate').value || todayIso();
  const end = document.getElementById('endDate').value || todayIso();
  const projeto = document.getElementById('projectFilter').value || '';

  const qs = new URLSearchParams({ acao:'dashboard', start, end, projeto, rows:'1' });
  const j = await getJson(`${WEB_APP_URL}?${qs.toString()}`);
  if (j.status !== 'success') { alert(j.message || 'Erro ao gerar relatório'); return; }

  const printArea = document.getElementById('printArea');
  if (printArea) printArea.innerHTML = buildPrintReportFromDashboardData(j);

  setTimeout(() => window.print(), 120);
}


async function loadProjects(){
  const j = await getJson(`${WEB_APP_URL}?acao=listaProjetos`);
  if (j.status !== 'success') return;

  const sel = document.getElementById('projectFilter');
  sel.innerHTML = '<option value="">Todos</option>';

  const lista = j.projects || j.projetos || j.groups || [];
  lista.forEach(p => {
    const nome = String((p && (p.projeto || p.project || p.group || p.nome)) || p || '').trim();
    if (!nome) return;

    const resp = String((p && (p.responsavel || p.responsible || p.chefe || p.chief)) || '').trim();

    const o = document.createElement('option');
    o.value = nome;
    o.textContent = resp ? `${nome} — ${resp}` : nome;
    sel.appendChild(o);
  });
}

async function loadDashboard(){
  const start = document.getElementById('startDate').value || todayIso();
  const end = document.getElementById('endDate').value || todayIso();
  const projeto = document.getElementById('projectFilter').value || '';

  const qs = new URLSearchParams({ acao:'dashboard', start, end, projeto, rows:'1' });
  const j = await getJson(`${WEB_APP_URL}?${qs.toString()}`);
  if (j.status !== 'success') { alert(j.message || 'Erro'); return; }

  document.getElementById('mTotal').textContent = j.metrics.totalLancamentos;
  document.getElementById('mPres').textContent = j.metrics.presentes;
  document.getElementById('mFalt').textContent = j.metrics.faltas;
  document.getElementById('mPct').textContent = `${j.metrics.frequenciaPct}%`;

  fillTable('#tblResumo tbody',
    (j.resumoPorGrupo || []).map(r => `<tr>
      <td>${r.group}</td><td>${r.total}</td><td>${r.presentes}</td><td>${r.faltas}</td><td>${r.observacoes}</td><td>${r.frequenciaPct}%</td>
    </tr>`),
    6
  );

  fillTable('#tblObs tbody',
    (j.observacoes || []).map(r => `<tr>
      <td>${r.date}</td><td>${r.group}</td><td>${r.student}</td><td>${r.present ? 'Presente' : 'Falta'}</td><td>${r.source || ''}</td><td>${String(r.observation||'').replace(/</g,'&lt;')}</td>
    </tr>`),
    6
  );
}

(async function(){
  const t = todayIso();
  startDate.value = t; endDate.value = t;
  await loadProjects();
  await loadDashboard();
  btnAtualizar.addEventListener('click', loadDashboard);
  document.getElementById('btnImprimirFaltas').addEventListener('click', imprimirRelatorioFaltas);
})();
</script>

<div id="printArea" style="display:none"></div>
</body>
</html>
