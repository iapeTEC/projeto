<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Dashboard de Presença</title>
  <link rel="icon" href="data:,">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
  <style>
    :root{
      --sb-primary:#4e73df; --sb-success:#1cc88a; --sb-info:#36b9cc; --sb-warning:#f6c23e; --sb-danger:#e74a3b;
      --sb-dark:#5a5c69; --sb-muted:#858796; --sb-border:#e3e6f0; --sb-bg:#f8f9fc;
      --sb-shadow:0 .15rem 1.75rem 0 rgba(58,59,69,.15);
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--sb-bg);color:#2e2f37;font-family:'Nunito',system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
    .topbar{background:#fff;border-bottom:1px solid var(--sb-border);box-shadow:0 .15rem .35rem rgba(58,59,69,.08)}
    .topbar .in{max-width:1280px;margin:0 auto;padding:12px 14px;display:flex;justify-content:space-between;align-items:center;gap:10px}
    .brand{font-weight:800;color:var(--sb-primary);display:flex;align-items:center;gap:8px}
    .dot{width:10px;height:10px;border-radius:50%;background:var(--sb-primary);display:inline-block}
    .muted{color:var(--sb-muted)}
    .wrap{max-width:1280px;margin:0 auto;padding:16px 14px}
    .card{background:#fff;border:1px solid var(--sb-border);border-radius:.5rem;box-shadow:var(--sb-shadow);margin-bottom:14px}
    .card-hd{padding:.85rem 1rem;border-bottom:1px solid var(--sb-border);display:flex;align-items:center;justify-content:space-between;gap:10px}
    .card-hd h2,.card-hd h3{margin:0;color:var(--sb-dark);font-weight:800}
    .card-bd{padding:1rem}
    .filters{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:10px;align-items:end}
    label{display:block;font-size:.9rem;font-weight:700;color:var(--sb-dark);margin:0 0 .35rem}
    input,select{width:100%;padding:.55rem .65rem;border:1px solid #d1d3e2;border-radius:.35rem;background:#fff;color:#3a3b45}
    input:focus,select:focus{outline:none;border-color:#bac8f3;box-shadow:0 0 0 .2rem rgba(78,115,223,.18)}
    .btns{display:flex;gap:8px;flex-wrap:wrap}
    button{padding:.55rem .85rem;border-radius:.35rem;border:1px solid transparent;font-weight:700;cursor:pointer;color:#fff;background:var(--sb-primary);box-shadow:0 .125rem .25rem rgba(58,59,69,.2)}
    button:hover{filter:brightness(.98)}
    #btnImprimirFaltas{background:var(--sb-info)}
    .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:14px;margin-bottom:14px}
    .metric{padding:14px 16px;border-left:.35rem solid var(--sb-primary)}
    .metric h4{margin:0;color:#6e707e;font-size:.72rem;text-transform:uppercase;letter-spacing:.06em;font-weight:800}
    .metric .v{margin-top:.35rem;font-size:1.45rem;color:var(--sb-dark);font-weight:800}
    .metric.pres{border-left-color:var(--sb-success)}
    .metric.falt{border-left-color:var(--sb-danger)}
    .metric.pct{border-left-color:var(--sb-info)}
    .metric.obs{border-left-color:var(--sb-warning)}
    table{width:100%;border-collapse:collapse;background:#fff}
    th,td{border:1px solid var(--sb-border);padding:.55rem .65rem;font-size:.9rem;text-align:left;vertical-align:top}
    thead th{background:#f8f9fc;color:#6e707e;font-size:.76rem;text-transform:uppercase;letter-spacing:.04em;font-weight:800}
    tbody tr:nth-child(even){background:#fbfcff}
    tbody tr:hover{background:#f3f6ff}
    .table-wrap{overflow:auto}
    .small{font-size:.85rem;color:var(--sb-muted)}
    .empty{padding:10px;border:1px dashed var(--sb-border);border-radius:8px;background:#fafafa;color:#667}
    .badge{display:inline-block;padding:.12rem .45rem;border-radius:999px;font-size:.75rem;font-weight:700;border:1px solid var(--sb-border);background:#fff}
    .badge.ok{color:#0f766e}
    .badge.no{color:#b91c1c}

    /* Print report */
    #printArea{display:none}
    .report-print{font-family:Arial,sans-serif;color:#111}
    .report-title{font-size:20px;font-weight:700;margin:0 0 4px}
    .report-sub{font-size:12px;color:#555;margin:0 0 14px}
    .report-section{margin:0 0 18px;page-break-inside:avoid}
    .report-section h4{margin:0 0 8px;padding:6px 8px;background:#e5e7eb;border-radius:6px}
    .report-table{width:100%;border-collapse:collapse;font-size:13px}
    .report-table th,.report-table td{border:1px solid #cbd5e1;padding:6px 8px;vertical-align:top}
    .report-table th{background:#f1f5f9}
    .report-table tbody tr:nth-child(even){background:#f8fafc}
    .report-empty{padding:10px;border:1px dashed #cbd5e1;border-radius:6px;color:#555;background:#fafafa}
    @media print{
      body *{visibility:hidden !important}
      #printArea,#printArea *{visibility:visible !important}
      #printArea{display:block !important;position:absolute;inset:0;background:#fff;padding:12mm}
      .report-section{page-break-inside:avoid}
    }
    @media (max-width:768px){
      .wrap{padding:10px}
      .card-bd{padding:.75rem}
      th,td{font-size:.82rem;padding:.45rem .5rem}
      .metric .v{font-size:1.15rem}
    }
  </style>
</head>
<body>
  <div class="topbar">
    <div class="in">
      <div class="brand"><span class="dot"></span> Dashboard de Frequência</div>
      <div class="small">Projetos • Tarde</div>
    </div>
  </div>

  <div class="wrap">
    <div class="card">
      <div class="card-hd"><h2>Filtros</h2></div>
      <div class="card-bd">
        <div class="filters">
          <div>
            <label for="startDate">Data inicial</label>
            <input type="date" id="startDate">
          </div>
          <div>
            <label for="endDate">Data final</label>
            <input type="date" id="endDate">
          </div>
          <div>
            <label for="projectFilter">Projeto</label>
            <select id="projectFilter">
              <option value="">Todos</option>
            </select>
          </div>
          <div>
            <label>&nbsp;</label>
            <div class="btns">
              <button id="btnAtualizar"><i class="fa-solid fa-rotate-right"></i> Atualizar</button>
              <button id="btnImprimirFaltas" type="button"><i class="fa-solid fa-print"></i> Imprimir faltas</button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="grid">
      <div class="card metric"><h4>Lançamentos</h4><div class="v" id="mTotal">0</div></div>
      <div class="card metric pres"><h4>Presentes</h4><div class="v" id="mPres">0</div></div>
      <div class="card metric falt"><h4>Faltas</h4><div class="v" id="mFalt">0</div></div>
      <div class="card metric pct"><h4>Frequência geral</h4><div class="v" id="mPct">0%</div></div>
      <div class="card metric obs"><h4>Observações</h4><div class="v" id="mObs">0</div></div>
    </div>

    <div class="card">
      <div class="card-hd"><h3>Resumo por projeto</h3></div>
      <div class="card-bd table-wrap">
        <table id="tblResumo">
          <thead>
            <tr>
              <th>Projeto</th>
              <th>Total</th>
              <th>Presentes</th>
              <th>Faltas</th>
              <th>Observações</th>
              <th>Frequência</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

    <div class="card">
      <div class="card-hd"><h3>Observações recentes</h3><span class="small">Máx. 6 na tela</span></div>
      <div class="card-bd table-wrap">
        <table id="tblObs">
          <thead>
            <tr>
              <th>Data</th>
              <th>Projeto</th>
              <th>Aluno</th>
              <th>Observação</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

    <div class="card">
      <div class="card-hd"><h3>Lançamentos recentes</h3><span class="small">Máx. 12 na tela</span></div>
      <div class="card-bd table-wrap">
        <table id="tblRows">
          <thead>
            <tr>
              <th>Data</th>
              <th>Projeto</th>
              <th>Responsável</th>
              <th>Aluno</th>
              <th>Presença</th>
              <th>Origem</th>
              <th>Observação</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>

  <div id="printArea"></div>

  <script src="assets/config2.js?v=1"></script>
  <script>
    const WEB_APP_URL = (window.APP_CONFIG && window.APP_CONFIG.API_URL) || '';
    if (!WEB_APP_URL) throw new Error('URL do Apps Script não configurada em assets/config2.js');

    const startDate = document.getElementById('startDate');
    const endDate = document.getElementById('endDate');
    const projectFilter = document.getElementById('projectFilter');
    const btnAtualizar = document.getElementById('btnAtualizar');

    function todayIso(){
      const d = new Date();
      const y = d.getFullYear();
      const m = String(d.getMonth()+1).padStart(2,'0');
      const day = String(d.getDate()).padStart(2,'0');
      return `${y}-${m}-${day}`;
    }

    async function getJson(url){
      const r = await fetch(url);
      const txt = await r.text();
      let j;
      try { j = JSON.parse(txt); }
      catch(e){ throw new Error('Resposta inválida do servidor (não-JSON).'); }
      if (!r.ok) throw new Error(`HTTP ${r.status}`);
      return j;
    }

    function escapeHtml(s){
      return String(s ?? '')
        .replace(/&/g,'&amp;')
        .replace(/</g,'&lt;')
        .replace(/>/g,'&gt;')
        .replace(/"/g,'&quot;');
    }

    function fillTable(selector, rowsHtml, limit){
      const tb = document.querySelector(selector);
      if (!tb) return;
      const arr = Array.isArray(rowsHtml) ? rowsHtml : [];
      const sliced = typeof limit === 'number' ? arr.slice(0, limit) : arr;
      tb.innerHTML = sliced.length ? sliced.join('') : '<tr><td colspan="20"><div class="empty">Sem dados no período selecionado.</div></td></tr>';
    }

    async function loadProjects(){
      const j = await getJson(`${WEB_APP_URL}?acao=listaProjetos`);
      if (j.status !== 'success') return;

      const lista = j.projects || j.projetos || j.groups || [];
      const current = projectFilter.value || '';
      projectFilter.innerHTML = '<option value="">Todos</option>';

      lista.forEach(p => {
        const nome = String((p && (p.projeto || p.project || p.group || p.nome)) || p || '').trim();
        if (!nome) return;
        const resp = String((p && (p.responsavel || p.responsible || p.chefe || p.chief)) || '').trim();
        const o = document.createElement('option');
        o.value = nome;
        o.textContent = resp ? `${nome} — ${resp}` : nome;
        projectFilter.appendChild(o);
      });

      if (current) projectFilter.value = current;
    }

    function setMetrics(metrics){
      document.getElementById('mTotal').textContent = Number(metrics?.totalLancamentos || 0);
      document.getElementById('mPres').textContent = Number(metrics?.presentes || 0);
      document.getElementById('mFalt').textContent = Number(metrics?.faltas || 0);
      document.getElementById('mPct').textContent = `${Number(metrics?.frequenciaPct || 0)}%`;
      document.getElementById('mObs').textContent = Number(metrics?.observacoes || 0);
    }

    function renderResumo(j){
      const linhas = (j.resumoPorGrupo || []).map(r => {
        const pct = Number(r.frequenciaPct || 0);
        return `<tr>
          <td>${escapeHtml(r.group || r.projeto || '')}</td>
          <td>${Number(r.total || 0)}</td>
          <td>${Number(r.presentes || 0)}</td>
          <td>${Number(r.faltas || 0)}</td>
          <td>${Number(r.observacoes || 0)}</td>
          <td>${pct}%</td>
        </tr>`;
      });
      fillTable('#tblResumo tbody', linhas, 200);
    }

    function renderObservacoes(j){
      const linhas = (j.observacoes || []).map(r => `<tr>
        <td>${escapeHtml(r.date || '')}</td>
        <td>${escapeHtml(r.group || '')}</td>
        <td>${escapeHtml(r.student || '')}</td>
        <td>${escapeHtml(r.observation || '')}</td>
      </tr>`);
      fillTable('#tblObs tbody', linhas, 6);
    }

    function renderRows(j){
      const linhas = (j.rows || []).slice().sort((a,b)=>{
        if ((a.date||'') === (b.date||'')) {
          const ga = String(a.group||'');
          const gb = String(b.group||'');
          if (ga === gb) return String(a.student||'').localeCompare(String(b.student||''), 'pt-BR');
          return ga.localeCompare(gb, 'pt-BR');
        }
        return String(a.date||'') < String(b.date||'') ? 1 : -1;
      }).map(r => `<tr>
        <td>${escapeHtml(r.date || '')}</td>
        <td>${escapeHtml(r.group || '')}</td>
        <td>${escapeHtml(r.responsible || '')}</td>
        <td>${escapeHtml(r.student || '')}</td>
        <td>${Number(r.present) === 1 ? '<span class="badge ok">Presente</span>' : '<span class="badge no">Falta</span>'}</td>
        <td>${escapeHtml(r.source || '')}</td>
        <td>${escapeHtml(r.observation || '')}</td>
      </tr>`);
      fillTable('#tblRows tbody', linhas, 12);
    }

    async function loadDashboard(){
      const start = startDate.value || todayIso();
      const end = endDate.value || todayIso();
      const projeto = projectFilter.value || '';

      const qs = new URLSearchParams({ acao:'dashboard', start, end, projeto, rows:'1' });
      const j = await getJson(`${WEB_APP_URL}?${qs.toString()}`);
      if (j.status !== 'success') throw new Error(j.message || 'Erro no dashboard');

      setMetrics(j.metrics || {});
      renderResumo(j);
      renderObservacoes(j);
      renderRows(j);
    }

    function groupAbsencesByProject(rows){
      const map = {};
      (rows || []).forEach(r => {
        if (Number(r.present) === 1) return;
        const projeto = String(r.group || r.projeto || 'Sem projeto').trim() || 'Sem projeto';
        if (!map[projeto]) map[projeto] = [];
        map[projeto].push(r);
      });
      return Object.keys(map).sort((a,b)=>a.localeCompare(b,'pt-BR')).map(projeto => ({
        projeto,
        itens: map[projeto].sort((a,b)=>{
          if ((a.date||'') === (b.date||'')) return String(a.student||'').localeCompare(String(b.student||''), 'pt-BR');
          return String(a.date||'') < String(b.date||'') ? -1 : 1;
        })
      }));
    }

    function buildPrintReportFromDashboardData(j){
      const start = startDate.value || todayIso();
      const end = endDate.value || todayIso();
      const rows = Array.isArray(j.rows) ? j.rows : [];
      const groups = groupAbsencesByProject(rows);
      const totalFaltas = rows.filter(r => Number(r.present) !== 1).length;

      let out = `
        <div class="report-print">
          <p class="report-title">Relatório de Faltas</p>
          <p class="report-sub">Período: ${escapeHtml(start)} a ${escapeHtml(end)}<br>
          Total de faltas: ${totalFaltas} | Setores com faltas: ${groups.length}</p>
      `;

      if (!groups.length) {
        out += `<div class="report-empty">Nenhuma falta registrada no período selecionado.</div>`;
      } else {
        groups.forEach(g => {
          out += `
            <section class="report-section">
              <h4>${escapeHtml(g.projeto)} (${g.itens.length} falta${g.itens.length>1?'s':''})</h4>
              <table class="report-table">
                <thead>
                  <tr>
                    <th style="width:110px">Data</th>
                    <th style="width:34%">Aluno</th>
                    <th style="width:140px">Responsável</th>
                    <th style="width:90px">Origem</th>
                    <th>Observação</th>
                  </tr>
                </thead>
                <tbody>`;
          g.itens.forEach(r => {
            out += `<tr>
              <td>${escapeHtml(r.date || '')}</td>
              <td>${escapeHtml(r.student || '')}</td>
              <td>${escapeHtml(r.responsible || '')}</td>
              <td>${escapeHtml(r.source || '')}</td>
              <td>${escapeHtml(r.observation || '')}</td>
            </tr>`;
          });
          out += `</tbody></table></section>`;
        });
      }

      out += `</div>`;
      return out;
    }

    async function imprimirRelatorioFaltas(){
      try {
        const start = startDate.value || todayIso();
        const end = endDate.value || todayIso();
        const projeto = projectFilter.value || '';
        const qs = new URLSearchParams({ acao:'dashboard', start, end, projeto, rows:'1' });
        const j = await getJson(`${WEB_APP_URL}?${qs.toString()}`);
        if (j.status !== 'success') throw new Error(j.message || 'Erro ao gerar relatório');

        const printArea = document.getElementById('printArea');
        printArea.innerHTML = buildPrintReportFromDashboardData(j);
        setTimeout(() => window.print(), 120);
      } catch (err) {
        alert('Erro ao imprimir relatório: ' + (err.message || err));
        console.error(err);
      }
    }

    (async function(){
      try {
        const t = todayIso();
        startDate.value = t;
        endDate.value = t;

        await loadProjects();
        await loadDashboard();

        btnAtualizar.addEventListener('click', loadDashboard);
        document.getElementById('btnImprimirFaltas').addEventListener('click', imprimirRelatorioFaltas);
      } catch (err) {
        console.error(err);
        alert('Erro ao carregar dashboard: ' + (err.message || err));
      }
    })();
  </script>
</body>
</html>
